{"version":3,"file":"menu.min.js","sources":["../src/menu.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manage the user menu.\n *\n * @module     theme_wwu2019/menu\n * @copyright  2019 Justus Dieckmann WWU\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Ajax from 'core/ajax';\n\n/**\n * Init function\n */\nexport function init() {\n    openMenu();\n    initThemeChooser();\n}\n\n\n/**\n * Initializes the theme chooser.\n */\nfunction initThemeChooser() {\n    const html = $('html');\n    const uselighttheme = $('#user-menu .wwu-uselighttheme');\n    const useostheme = $('#user-menu .wwu-useostheme');\n    const usedarktheme = $('#user-menu .wwu-usedarktheme');\n\n    let selected;\n    if (html.hasClass('dark')) {\n        selected = usedarktheme;\n    } else if (html.hasClass('light')) {\n        selected = uselighttheme;\n    } else {\n        selected = useostheme;\n    }\n    selected.addClass('selectedtheme');\n\n    uselighttheme.click(function() {\n        selected.removeClass('selectedtheme');\n        html.removeClass('dark');\n        html.addClass('light');\n        updateThemePreferenceAjax(1);\n        selected = uselighttheme;\n        selected.addClass('selectedtheme');\n    });\n    useostheme.click(function() {\n        selected.removeClass('selectedtheme');\n        html.removeClass('dark');\n        html.removeClass('light');\n        updateThemePreferenceAjax(null);\n        selected = useostheme;\n        selected.addClass('selectedtheme');\n    });\n    usedarktheme.click(function() {\n        selected.removeClass('selectedtheme');\n        html.addClass('dark');\n        html.removeClass('light');\n        updateThemePreferenceAjax(2);\n        selected = usedarktheme;\n        selected.addClass('selectedtheme');\n    });\n}\n\n/**\n * Updates the theme preference.\n * @param {int} theme\n */\nfunction updateThemePreferenceAjax(theme) {\n    var request = {\n        methodname: 'core_user_update_user_preferences',\n        args: {\n            preferences: [{\n                type: 'theme_wwu2019_theme',\n                value: theme\n            }]\n        }\n    };\n\n    Ajax.call([request])[0]\n        .fail(Notification.exception);\n}\n\nconst onecolumnbreakpoint = 767;\nconst hamburgerbreakpoint = 1080;\n\n\n/**\n * Opens submenu when hovering\n */\nfunction openMenu() {\n    const openDelay = 100;\n    const closeDelay = 300;\n    const closeCooldown = 300;\n\n    let openMenu = null;\n    let openCandidate = null;\n    let openTimeoutId = null;\n    let closeTimeoutId = null;\n    /** @type {null|Date} Date when menu was opened by hovering, to prevent immediately closing it by clicking again. */\n    let openTime = null;\n\n    /**\n     * Opens a menu.\n     * @param {Node} menuItem the menuItem DOM-Element\n     */\n    function open(menuItem) {\n        if (openMenu) {\n            close(openMenu);\n        }\n        abortClose();\n        $(menuItem).addClass('open');\n        $(menuItem).children('a').attr('aria-expanded', 'true');\n        openMenu = menuItem;\n        openCandidate = null;\n        openTimeoutId = null;\n    }\n\n    /**\n     * Opens a menu with delay.\n     * @param {Node} menuItem the menuItem DOM-Element\n     */\n    function openWithDelay(menuItem) {\n        openCandidate = menuItem;\n        openTimeoutId = setTimeout(() => {\n            open(menuItem);\n            openTime = new Date();\n        }, openDelay);\n    }\n\n    /**\n     * Closes a menu.\n     * @param {Node} menuItem the menuItem DOM-Element\n     */\n    function close(menuItem) {\n        $(menuItem).removeClass('open');\n        $(menuItem).children('a').attr('aria-expanded', 'false');\n        openMenu = null;\n        abortClose();\n        openTime = null;\n    }\n\n    /**\n     * Closes a menu with delay.\n     * @param {Node} menuItem the menuItem DOM-Element\n     */\n    function closeWithDelay(menuItem) {\n        closeTimeoutId = setTimeout(close, closeDelay, menuItem);\n    }\n\n    /**\n     * Aborts the delayed closing of {@link openMenu}\n     */\n    function abortClose() {\n        if (closeTimeoutId) {\n            clearTimeout(closeTimeoutId);\n            closeTimeoutId = null;\n        }\n    }\n\n    /**\n     * Aborts the delayed opening of {@link openCandidate}\n     */\n    function abortOpen() {\n        openCandidate = null;\n        if (openTimeoutId) {\n            clearTimeout(openTimeoutId);\n            openTimeoutId = null;\n        }\n    }\n\n    /**\n     * Closes the open menu and resets timeouts;\n     */\n    function reset() {\n        abortClose();\n        abortOpen();\n        if (openMenu) {\n            close(openMenu);\n        }\n    }\n\n    $('li.main-menu-item > a[aria-haspopup=\"true\"], li#user-menu > a[aria-haspopup=\"true\"]').click((ev) => {\n        if (ev.currentTarget.parentNode === openMenu) {\n            if (new Date() - openTime > closeCooldown) {\n                close(openMenu);\n            }\n        } else {\n            open(ev.currentTarget.parentNode);\n        }\n    });\n\n    let menuitems = $('li.main-menu-item > a[aria-haspopup=\"true\"], li#user-menu > a[aria-haspopup=\"true\"]').parent();\n    menuitems.mouseenter((ev) => {\n        let width = (window.innerWidth > 0) ? window.innerWidth : screen.width;\n        if (width > onecolumnbreakpoint) {\n            if (ev.currentTarget === openMenu) {\n                abortClose();\n            } else {\n                openWithDelay(ev.currentTarget);\n            }\n        }\n    });\n    menuitems.mouseleave((ev) => {\n        let width = (window.innerWidth > 0) ? window.innerWidth : screen.width;\n        if (width > onecolumnbreakpoint) {\n            if (openCandidate && ev.currentTarget === openCandidate) {\n                abortOpen();\n            }\n            if (openMenu && ev.currentTarget === openMenu) {\n                closeWithDelay(ev.currentTarget);\n            }\n        }\n    });\n\n    $('li.sub-menu-item > a[aria-haspopup=\"true\"], li.sub-sub-menu-item > a[aria-haspopup=\"true\"]').click((ev) => {\n        let link = $(ev.currentTarget);\n        let item = link.parent();\n        item.toggleClass('open');\n        link.attr('aria-expanded', item.hasClass('open'));\n    });\n\n    let hamburgertoggle = $('#main-menu-hamburger > a');\n    let hamburgerparent = hamburgertoggle.parent();\n    hamburgertoggle.click(() => {\n        hamburgerparent.toggleClass('open');\n        hamburgertoggle.attr('aria-expanded', hamburgerparent.hasClass('open'));\n    });\n\n    let oneColLayoutBefore = false;\n    let hamburgerLayoutBefore = false;\n\n    /**\n     * Updates max-height of submenus on page-init and window resize.\n     */\n    function updateMaxMenuHeight() {\n        const menuButtom = $('#menu-bottom');\n        let botPos = menuButtom.offset().top + 16;\n        let width = (window.innerWidth > 0) ? window.innerWidth : screen.width;\n        let oneColLayout = width <= onecolumnbreakpoint;\n        if (oneColLayout) {\n            $('.sub-menu-scroll-container').css('max-height', '');\n            $('#main-menu-left').css('max-height', ($(window).height() - botPos) + 'px');\n        } else {\n            // If Menu is expanded down, add the height of the #main-menu-left container\n            if (width <= hamburgerbreakpoint) {\n                botPos += 50;\n            }\n            $('.sub-menu-scroll-container').css('max-height', ($(window).height() - botPos) + 'px');\n            $('#main-menu-left').css('max-height', '');\n        }\n        if (oneColLayout !== oneColLayoutBefore) {\n            reset();\n            oneColLayoutBefore = oneColLayout;\n        }\n\n        // Switch hamburger toggle role between button and none, based on whether it is hidden.\n        let hamburgerLayout = width <= hamburgerbreakpoint;\n        if (hamburgerLayout !== hamburgerLayoutBefore) {\n            hamburgertoggle.attr('role', hamburgerLayout ? 'button' : 'none');\n            hamburgerLayoutBefore = hamburgerLayout;\n        }\n    }\n\n    updateMaxMenuHeight();\n    $(window).resize(updateMaxMenuHeight);\n}\n"],"names":["updateThemePreferenceAjax","theme","request","methodname","args","preferences","type","value","call","fail","Notification","exception","openDelay","closeDelay","closeCooldown","openMenu","openCandidate","openTimeoutId","closeTimeoutId","openTime","open","menuItem","close","abortClose","addClass","children","attr","openWithDelay","setTimeout","Date","removeClass","closeWithDelay","clearTimeout","abortOpen","reset","click","ev","currentTarget","parentNode","menuitems","parent","mouseenter","window","innerWidth","screen","width","mouseleave","link","item","toggleClass","hasClass","hamburgertoggle","hamburgerparent","oneColLayoutBefore","hamburgerLayoutBefore","updateMaxMenuHeight","botPos","offset","top","oneColLayout","css","height","hamburgerLayout","resize","html","uselighttheme","useostheme","usedarktheme","selected","initThemeChooser"],"mappings":"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"}